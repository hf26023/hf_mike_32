#include "my_usart.h"
#include "stdlib.h"
User_USART BT_Data;		//接收数据

//初始化函数
void User_USART_Init(User_USART *Data)
{
    for(uint8_t i=0; i < RXBUFFER_LEN; i++)	Data->RxBuffer[i] = 0;
    Data->frame_head = 0xA5;
    Data->frame_tail = 0x5A;
    Data->Rx_flag = 0;
    Data->Rx_len = 0;//aileron,elevator,throttle,rudder,x,y,claw,mode,z;
    Data->aileron = 0;
    Data->elevator = 0;
    Data->throttle = 0;
    Data->rudder = 0;
    Data->x = 0;
    Data->y = 0;
    Data->claw = 0;
    Data->mode = 0;
    Data->z = 0;
		Data->m4mode = 1;
}

void BTData_Process(uint8_t *RxBuffer)
{
    //检查帧头帧尾
    if(RxBuffer[0] != BT_Data.frame_head) return;
    if(RxBuffer[12] != BT_Data.frame_tail) return;

//		BT_Data.x = (RxBuffer[3]<<8)|RxBuffer[2];
//		BT_Data.y = (RxBuffer[5]<<8)|RxBuffer[4];
//		BT_Data.w = (RxBuffer[7]<<8)|RxBuffer[6];
//		BT_Data.h = (RxBuffer[9]<<8)|RxBuffer[8];//aileron,elevator,throttle,rudder,x,y,claw,mode;
    BT_Data.aileron = RxBuffer[1];
    BT_Data.elevator = RxBuffer[2];
    BT_Data.throttle = RxBuffer[3];
    BT_Data.rudder = RxBuffer[4];
    BT_Data.x = RxBuffer[5];
    BT_Data.y = RxBuffer[6];
    BT_Data.claw = RxBuffer[7];
    BT_Data.mode = RxBuffer[8];
    BT_Data.z = RxBuffer[9];
		BT_Data.m4mode = RxBuffer[10];



    if (BT_Data.aileron>127) BT_Data.aileron-=255;
    if (abs(BT_Data.aileron)<10) BT_Data.aileron = 0;//消除转向抖动
    if (BT_Data.elevator>127) BT_Data.elevator-=255;
    if (abs(BT_Data.elevator)<10) BT_Data.elevator = 0;//消除前进抖动
    if (BT_Data.throttle>127) BT_Data.throttle-=255;
    if (abs(BT_Data.throttle)<10) BT_Data.throttle = 0;//消除前进抖动
    if (BT_Data.rudder>127) BT_Data.rudder-=255;
    if (abs(BT_Data.rudder)<10) BT_Data.rudder = 0;//消除前进抖动
    if (BT_Data.x>127) BT_Data.x-=255;
    if (BT_Data.y>127) BT_Data.y-=255;
    if (BT_Data.z>127) BT_Data.z-=255;
    if (BT_Data.claw>127) BT_Data.claw-=255;
    BT_Data.claw+=128;

}

/*下面这段加到main的初始化里

	//初始化接收结构体
	User_USART_Init(&BT_Data);
	// 加入DMA空闲中断
	__HAL_UART_ENABLE_IT(&huart3,UART_IT_IDLE);
	HAL_UART_Receive_DMA(&huart3,BT_Data.RxBuffer,RXBUFFER_LEN);

*/